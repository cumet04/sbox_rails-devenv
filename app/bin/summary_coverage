#!/usr/bin/env ruby

require "json"
require "csv"

root = File.expand_path("..", __dir__)
input_path = File.join(root, "coverage/coverage.json")
raw = JSON.parse(input_path)

source_root = File.join(root, "app")

out = CSV.generate do |csv|
  csv << ["file", "cover[%]", "lines", "relevant lines", "lines covered"]

  raw["coverage"].map do |key, values|
    data = values["lines"]
    lines = data.count

    valid = data.reject(&:nil?)
    relevant_lines = valid.count
    lines_covered = valid.count(&:positive?)

    cover = 100.0 * lines_covered / relevant_lines
    path = key.delete_prefix(source_root)
    csv << [path, cover, lines, relevant_lines, lines_covered]
  end
end

puts out
